<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Carte AR</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --surface: #ffffff;
            --border: #e2e6ee;
            --accent: #e63946;
            --text: #1a1d2e;
            --muted: #8a929f;
            --device: #4285F4;
            --panel-h: 44px;
        }

        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            background: #e8edf2;
        }

        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        /* ‚îÄ‚îÄ Panneau bas ‚îÄ‚îÄ */
        #bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 10;
            background: var(--surface);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 12px rgba(0,0,0,0.10);
            border-radius: 14px 14px 0 0;
        }

        .drag-handle {
            width: 36px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 8px auto 4px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 16px;
            height: var(--panel-h);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s;
        }

        .row:last-child { border-bottom: none; }
        .row:active, .row.active { background: rgba(230,57,70,0.05); }

        .row img { width: 18px; height: 18px; object-fit: contain; flex-shrink: 0; }

        .row-name {
            font-size: 0.78rem; font-weight: 700;
            color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            flex: 1;
        }

        .row-coords {
            font-size: 0.65rem; color: var(--muted);
            text-align: right; white-space: nowrap; flex-shrink: 0;
        }

        .row.device .row-name { color: var(--device); }

        /* ‚îÄ‚îÄ Badges haut ‚îÄ‚îÄ */
        #badges {
            position: absolute;
            top: 12px; right: 12px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .badge {
            background: var(--surface);
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 0.65rem;
            color: var(--muted);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            white-space: nowrap;
        }

        .badge.active   { color: #22c55e; }
        .badge.compass  { color: var(--muted); }
        .badge.compass.active { color: #f59e0b; }

        /* ‚îÄ‚îÄ Bouton boussole (coin haut gauche, sous les zooms) ‚îÄ‚îÄ */
        #compass-btn {
            position: absolute;
            top: 96px; left: 12px;
            z-index: 20;
            width: 34px; height: 34px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: background 0.15s;
        }

        #compass-btn.active {
            background: #fff8e7;
            border-color: #f59e0b;
        }

        /* Rose des vents ‚Äî indicateur de rotation sur la carte */
        #north-indicator {
            position: absolute;
            top: 96px; right: 12px;
            z-index: 20;
            width: 34px; height: 34px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
            transform-origin: center;
            pointer-events: none;
        }

        #north-indicator.visible { display: flex; }

        /* ‚îÄ‚îÄ Popup ‚îÄ‚îÄ */
        .ol-popup {
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 150px;
            pointer-events: none;
            transform: translate(-50%, -115%);
            font-size: 0.72rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .ol-popup b { display: block; margin-bottom: 3px; color: var(--accent); font-size: 0.75rem; }
        .ol-popup.device b { color: var(--device); }
        .ol-popup span { color: var(--muted); line-height: 1.6; }

        /* ‚îÄ‚îÄ Contr√¥les OL ‚îÄ‚îÄ */
        .ol-zoom { top: 12px; left: 12px; right: auto; }
        .ol-zoom button {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 34px; height: 34px;
            font-size: 1.1rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .ol-attribution { display: none; }

        /* Bouton iOS autorisation */
        #ios-btn {
            display: none;
            position: absolute;
            bottom: 50%; left: 50%;
            transform: translate(-50%, 50%);
            z-index: 30;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px 24px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Badges GPS + boussole -->
<div id="badges">
    <span class="badge" id="gps-badge">‚è≥ GPS‚Ä¶</span>
    <span class="badge compass" id="compass-badge">üß≠ boussole‚Ä¶</span>
</div>

<!-- Bouton toggle boussole -->
<button id="compass-btn" title="Orienter selon le nord">üß≠</button>

<!-- Indicateur nord (fl√®che qui tourne) -->
<div id="north-indicator" class="visible">üî∫</div>

<!-- Popup -->
<div id="popup" class="ol-popup" style="display:none;">
    <b id="popup-name"></b>
    <span id="popup-coords"></span>
</div>

<!-- Panneau bas -->
<div id="bottom-panel">
    <div class="drag-handle"></div>
    <div class="row device" id="device-row">
        <img src="device.png" alt="device">
        <span class="row-name">Ma position</span>
        <span class="row-coords" id="device-coords">‚Äì</span>
    </div>
    <div id="points-list"></div>
</div>

<!-- Bouton iOS autorisation capteurs -->
<button id="ios-btn">üß≠ Autoriser la boussole</button>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DONN√âES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const somePlaces = [
    { name: "Point 1", lonlat: [0.712889, 47.409500] },
    { name: "Point 2", lonlat: [0.710982, 47.309539] }
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Carte
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = new ol.Map({
    target: 'map',
    layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
    view: new ol.View({
        center: ol.proj.fromLonLat([0.712, 47.36]),
        zoom: 12
    }),
    controls: ol.control.defaults.defaults({ attribution: false })
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Marqueurs AR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const features = somePlaces.map((place, i) => {
    const f = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat(place.lonlat)),
        name: place.name || `Point ${i + 1}`,
        lonlat: place.lonlat,
        type: 'ar'
    });
    f.setStyle(new ol.style.Style({
        image: new ol.style.Icon({ src: 'marker.png', anchor: [0.5, 1], scale: 1.3 })
    }));
    return f;
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Marqueur device
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const deviceFeature = new ol.Feature({ name: 'Ma position', type: 'device' });
deviceFeature.setStyle(new ol.style.Style({
    image: new ol.style.Icon({ src: 'device.png', anchor: [0.5, 0.5], scale: 1.2 })
}));

const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [...features, deviceFeature] })
});
map.addLayer(vectorLayer);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const gpsBadge     = document.getElementById('gps-badge');
const deviceCoords = document.getElementById('device-coords');
const deviceRow    = document.getElementById('device-row');

if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
        (pos) => {
            const lon = pos.coords.longitude;
            const lat = pos.coords.latitude;
            deviceFeature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([lon, lat])));
            deviceCoords.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            gpsBadge.textContent = '‚óè GPS';
            gpsBadge.classList.add('active');
        },
        (err) => { gpsBadge.textContent = '‚úó GPS'; console.error(err); },
        { enableHighAccuracy: true, maximumAge: 2000 }
    );
} else {
    gpsBadge.textContent = '‚úó GPS';
}

deviceRow.addEventListener('click', () => {
    const geom = deviceFeature.getGeometry();
    if (geom) map.getView().animate({ center: geom.getCoordinates(), zoom: 17, duration: 500 });
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  BOUSSOLE ‚Äî orientation magn√©tique
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const compassBadge    = document.getElementById('compass-badge');
const compassBtn      = document.getElementById('compass-btn');
const northIndicator  = document.getElementById('north-indicator');
const iosBtn          = document.getElementById('ios-btn');

let compassActive  = false;   // boussole activ√©e par l'utilisateur
let currentHeading = null;    // dernier cap connu (degr√©s)
let headingBuffer  = [];      // lissage sur 5 valeurs
const BUFFER_SIZE  = 5;

// Lissage circulaire du cap (√©vite les sauts 359¬∞ ‚Üí 1¬∞)
function smoothHeading(newVal) {
    headingBuffer.push(newVal);
    if (headingBuffer.length > BUFFER_SIZE) headingBuffer.shift();

    // Moyenne circulaire
    let sinSum = 0, cosSum = 0;
    headingBuffer.forEach(h => {
        sinSum += Math.sin(h * Math.PI / 180);
        cosSum += Math.cos(h * Math.PI / 180);
    });
    return (Math.atan2(sinSum, cosSum) * 180 / Math.PI + 360) % 360;
}

// Applique la rotation √† la carte
function applyHeading(heading) {
    currentHeading = heading;
    const smooth   = smoothHeading(heading);
    const rotation = smooth * Math.PI / 180;   // OL attend des radians

    map.getView().setRotation(rotation);

    // L'indicateur nord tourne en sens inverse pour pointer vers le haut
    northIndicator.style.transform = `rotate(${-smooth}deg)`;

    compassBadge.textContent = `üß≠ ${Math.round(smooth)}¬∞`;
    compassBadge.classList.add('active');
}

// Handler DeviceOrientationEvent
function onOrientation(e) {
    if (!compassActive) return;

    let heading = null;

    // iOS : webkitCompassHeading est direct (nord magn√©tique)
    if (e.webkitCompassHeading !== undefined && e.webkitCompassHeading !== null) {
        heading = e.webkitCompassHeading;
    }
    // Android : alpha est par rapport au nord mais dans le sens inverse
    else if (e.alpha !== null) {
        heading = (360 - e.alpha) % 360;
    }

    if (heading !== null) applyHeading(heading);
}

// Activation / d√©sactivation boussole
function enableCompass() {
    compassActive = true;
    compassBtn.classList.add('active');
    northIndicator.classList.add('visible');
    window.addEventListener('deviceorientationabsolute', onOrientation, true);
    window.addEventListener('deviceorientation',         onOrientation, true);
}

function disableCompass() {
    compassActive = false;
    compassBtn.classList.remove('active');
    headingBuffer = [];
    map.getView().setRotation(0);   // remet le nord en haut
    compassBadge.textContent = 'üß≠ d√©sactiv√©e';
    compassBadge.classList.remove('active');
    northIndicator.style.transform = 'rotate(0deg)';
    window.removeEventListener('deviceorientationabsolute', onOrientation, true);
    window.removeEventListener('deviceorientation',         onOrientation, true);
}

// Bouton toggle
compassBtn.addEventListener('click', () => {
    if (compassActive) {
        disableCompass();
        return;
    }

    // iOS 13+ : demande d'autorisation obligatoire
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(state => {
                if (state === 'granted') {
                    enableCompass();
                } else {
                    compassBadge.textContent = 'üß≠ refus√©e';
                }
            })
            .catch(console.error);
    } else {
        // Android & autres
        enableCompass();
    }
});

// Sur iOS, le requestPermission ne peut √™tre appel√© que depuis un geste utilisateur.
// Le bouton principal g√®re d√©j√† √ßa. Le bouton ios-btn est un fallback visible si besoin.
if (typeof DeviceOrientationEvent !== 'undefined' &&
    typeof DeviceOrientationEvent.requestPermission === 'function') {
    // iOS d√©tect√© ‚Äî le bouton principal suffit, pas besoin du fallback
} else {
    iosBtn.style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Liste points AR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const list = document.getElementById('points-list');

somePlaces.forEach((place, i) => {
    const name = place.name || `Point ${i + 1}`;
    const row  = document.createElement('div');
    row.className    = 'row';
    row.dataset.name = name;
    row.innerHTML = `
        <img src="marker.png" alt="marker">
        <span class="row-name">${name}</span>
        <span class="row-coords">${place.lonlat[1].toFixed(5)}, ${place.lonlat[0].toFixed(5)}</span>
    `;
    row.addEventListener('click', () => {
        map.getView().animate({ center: ol.proj.fromLonLat(place.lonlat), zoom: 17, duration: 500 });
        document.querySelectorAll('.row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
    });
    list.appendChild(row);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Popup
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const popup       = document.getElementById('popup');
const popupName   = document.getElementById('popup-name');
const popupCoords = document.getElementById('popup-coords');

const overlayPopup = new ol.Overlay({
    element: popup, positioning: 'bottom-center', stopEvent: false
});
map.addOverlay(overlayPopup);

map.on('pointermove', (e) => {
    const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
    if (feature && feature.getGeometry()) {
        const geom = feature.getGeometry().getCoordinates();
        const ll   = ol.proj.toLonLat(geom);
        popupName.textContent  = feature.get('name');
        popupCoords.innerHTML  = `${ll[1].toFixed(6)}<br>${ll[0].toFixed(6)}`;
        popup.className = 'ol-popup' + (feature.get('type') === 'device' ? ' device' : '');
        overlayPopup.setPosition(geom);
        popup.style.display = 'block';
        map.getViewport().style.cursor = 'pointer';
    } else {
        popup.style.display = 'none';
        map.getViewport().style.cursor = '';
    }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Vue initiale
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
    if (features.length > 1) {
        const ph = document.getElementById('bottom-panel').offsetHeight;
        const extent = vectorLayer.getSource().getExtent();
        map.getView().fit(extent, {
            padding: [40, 20, ph + 20, 20],
            maxZoom: 16, duration: 800
        });
    }
    map.updateSize();
});
</script>

</body>
</html>
