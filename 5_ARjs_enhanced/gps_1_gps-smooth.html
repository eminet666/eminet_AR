<!DOCTYPE html>
<html>

<head>
    <title>AR.js A-Frame Location-based - GPS Lissé</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

    <script>
        AFRAME.registerComponent('smooth-gps', {
            schema: {
                bufferSize: { type: 'int', default: 5 },    // nombre de mesures à moyenner
                interval: { type: 'int', default: 2000 }  // intervalle entre mesures en ms
            },

            init() {
                this.buffer = [];
                this.watchId = null;
                this.startWatching();
            },

            startWatching() {
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.onPosition(position),
                    (err) => console.error('GPS error:', err),
                    { enableHighAccuracy: true, maximumAge: this.data.interval }
                );
            },

            onPosition(position) {
                const { latitude, longitude } = position.coords;

                // Ajout au buffer
                this.buffer.push({ latitude, longitude });

                // On garde seulement les N dernières mesures
                if (this.buffer.length > this.data.bufferSize) {
                    this.buffer.shift();
                }

                // Calcul de la moyenne
                const avg = this.buffer.reduce(
                    (acc, pos) => ({
                        latitude: acc.latitude + pos.latitude / this.buffer.length,
                        longitude: acc.longitude + pos.longitude / this.buffer.length
                    }),
                    { latitude: 0, longitude: 0 }
                );

                // Injection dans gps-new-camera
                const camera = this.el;
                camera.setAttribute('gps-new-camera', {
                    latitude: avg.latitude,
                    longitude: avg.longitude
                });

                console.log(`GPS lissé → lat: ${avg.latitude.toFixed(7)}, lon: ${avg.longitude.toFixed(7)}`);
            },

            remove() {
                if (this.watchId) navigator.geolocation.clearWatch(this.watchId);
            }
        });
    </script>
</head>

<body>
    <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
        renderer='antialias: true; alpha: true'>

        <!-- gpsMinDistance: 0 car c'est smooth-gps qui gère les mises à jour -->
        <a-camera smooth-gps="bufferSize: 5; interval: 2000" gps-new-camera='gpsMinDistance: 0'>
        </a-camera>

        <!-- écart 0.00002 dégré en +/- en latitude et longitude -->
        <!-- Tours_StLibert = 47.40952718300422, 0.7131772709286159 -->
        <a-box color="red" gps-new-entity-place="latitude: 47.40952718300422; longitude: 0.7131772709286159" depth="2"
            height="2" width="2" rotation="45 45 45" position="0 1 0"></a-box>

    </a-scene>
</body>

</html>