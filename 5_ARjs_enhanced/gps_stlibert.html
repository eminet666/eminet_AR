<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>AR.js - GPS Lissé + Gyro Stabilisé</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

    <script>

    // ═══════════════════════════════════════════════════════
    //  COMPOSANT 1 : smooth-gps
    // ═══════════════════════════════════════════════════════
    AFRAME.registerComponent('smooth-gps', {
        schema: {
            bufferSize: { type: 'int', default: 5 },
            interval:   { type: 'int', default: 2000 }
        },

        init() {
            this.buffer  = [];
            this.watchId = null;
            this.startWatching();
        },

        startWatching() {
            this.watchId = navigator.geolocation.watchPosition(
                (position) => this.onPosition(position),
                (err) => console.error('GPS error:', err),
                { enableHighAccuracy: true, maximumAge: this.data.interval }
            );
        },

        onPosition(position) {
            const { latitude, longitude } = position.coords;

            this.buffer.push({ latitude, longitude });
            if (this.buffer.length > this.data.bufferSize) this.buffer.shift();

            const avg = this.buffer.reduce(
                (acc, pos) => ({
                    latitude:  acc.latitude  + pos.latitude  / this.buffer.length,
                    longitude: acc.longitude + pos.longitude / this.buffer.length
                }),
                { latitude: 0, longitude: 0 }
            );

            this.el.setAttribute('gps-new-camera', {
                latitude:  avg.latitude,
                longitude: avg.longitude
            });

            console.log(`GPS lissé → lat: ${avg.latitude.toFixed(7)}, lon: ${avg.longitude.toFixed(7)}`);
        },

        remove() {
            if (this.watchId) navigator.geolocation.clearWatch(this.watchId);
        }
    });


    // ═══════════════════════════════════════════════════════
    //  COMPOSANT 2 : gyro-orientation
    // ═══════════════════════════════════════════════════════
    AFRAME.registerComponent('gyro-orientation', {
        schema: {
            bufferSize: { type: 'int',     default: 8    },
            enabled:    { type: 'boolean', default: true }
        },

        init() {
            this.buffer    = [];
            this.lastAlpha = null;
            this.bound     = this.onOrientation.bind(this);

            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.addEventListener('touchstart', () => {
                    DeviceOrientationEvent.requestPermission()
                        .then(state => {
                            if (state === 'granted') this.startListening();
                            else console.warn('Orientation refusée (iOS)');
                        })
                        .catch(console.error);
                }, { once: true });
            } else {
                this.startListening();
            }
        },

        startListening() {
            window.addEventListener('deviceorientationabsolute', this.bound, true);
            window.addEventListener('deviceorientation',         this.bound, true);
            console.log('gyro-orientation : écoute active');
        },

        onOrientation(e) {
            if (!this.data.enabled) return;

            let heading = null;
            if (e.webkitCompassHeading != null) {
                heading = e.webkitCompassHeading;
            } else if (e.alpha != null) {
                heading = (360 - e.alpha) % 360;
            }
            if (heading === null) return;

            this.buffer.push(heading);
            if (this.buffer.length > this.data.bufferSize) this.buffer.shift();

            let sinSum = 0, cosSum = 0;
            this.buffer.forEach(h => {
                sinSum += Math.sin(h * Math.PI / 180);
                cosSum += Math.cos(h * Math.PI / 180);
            });
            const smoothed = (Math.atan2(sinSum, cosSum) * 180 / Math.PI + 360) % 360;

            const cam = this.el.object3D;
            if (cam) {
                const yaw   = THREE.MathUtils.degToRad(-smoothed);
                const euler = new THREE.Euler().setFromQuaternion(cam.quaternion, 'YXZ');
                euler.y = yaw;
                cam.quaternion.setFromEuler(euler);
            }

            this.lastAlpha = smoothed;
        },

        remove() {
            window.removeEventListener('deviceorientationabsolute', this.bound, true);
            window.removeEventListener('deviceorientation',         this.bound, true);
        }
    });

    </script>
</head>

<body>
    <a-scene vr-mode-ui='enabled: false'
             arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
             renderer='antialias: true; alpha: true'>

        <a-assets>
            <a-asset-item id="statue" src="./assets/3Dscan_baracco.glb"></a-asset-item>
        </a-assets>

        <a-camera
            smooth-gps="bufferSize: 5; interval: 2000"
            gyro-orientation="bufferSize: 8; enabled: true"
            gps-new-camera='gpsMinDistance: 0'>
        </a-camera>

        <!-- Centre -->
        <a-box color="red"
               gps-new-entity-place="latitude: 47.409839; longitude: 0.712794"
               depth="2" height="2" width="2"
               rotation="45 45 45"
               position="0 1 0">
        </a-box>
        <a-text value="TEXTE"
                gps-new-entity-place="latitude: 47.409839; longitude: 0.712794"
                color="blue"
                align="center"
                look-at="[gps-new-camera]"
                position="0 1 0">
        </a-text>

        <!-- NO -->
        <a-box color="blue"
               gps-new-entity-place="latitude: 47.409870; longitude: 0.713199"
               depth="2" height="2" width="2"
               rotation="45 45 45"
               position="0 1 0">
        </a-box>
        <a-text value="TEXTE"
                gps-new-entity-place="latitude: 47.409870; longitude: 0.713199"
                color="blue"
                align="center"
                look-at="[gps-new-camera]"
                position="0 1 0">
        </a-text>

        <!-- NE : box verte + modèle GLB superposés -->
        <a-box color="green"
               gps-new-entity-place="latitude: 47.409596; longitude: 0.713282"
               depth="2" height="2" width="2"
               rotation="45 45 45"
               position="0 1 0">
        </a-box>
        <a-entity gps-new-entity-place="latitude: 47.409596; longitude: 0.713282"
                  position="0 1 0"
                  rotation="45 45 45"
                  gltf-model="#statue">
        </a-entity>

        <!-- SO -->
        <a-box color="yellow"
               gps-new-entity-place="latitude: 47.409688; longitude: 0.713112"
               depth="2" height="2" width="2"
               rotation="45 45 45"
               position="0 1 0">
        </a-box>
        <a-text value="TEXTE"
                gps-new-entity-place="latitude: 47.409688; longitude: 0.713112"
                color="blue"
                align="center"
                look-at="[gps-new-camera]"
                position="0 1 0">
        </a-text>

        <!-- S -->
        <a-box color="white"
               gps-new-entity-place="latitude: 47.409546; longitude: 0.712849"
               depth="2" height="2" width="2"
               rotation="45 45 45"
               position="0 1 0">
        </a-box>
        <a-text value="TEXTE"
                gps-new-entity-place="latitude: 47.409546; longitude: 0.712849"
                color="blue"
                align="center"
                look-at="[gps-new-camera]"
                position="0 1 0">
        </a-text>

    </a-scene>
</body>

</html>
