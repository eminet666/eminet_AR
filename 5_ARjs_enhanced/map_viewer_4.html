<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Carte AR</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --surface: #ffffff;
            --border: #e2e6ee;
            --accent: #e63946;
            --text: #1a1d2e;
            --muted: #8a929f;
            --device: #4285F4;
        }

        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            background: #e8edf2;
        }

        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        /* Fiche info bas d'Ã©cran */
        #info-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 10;
            background: var(--surface);
            border-top: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
            padding: 10px 20px 28px;
            transform: translateY(100%);
            transition: transform 0.28s cubic-bezier(0.34, 1.2, 0.64, 1);
        }

        #info-panel.visible { transform: translateY(0); }

        .drag-handle {
            width: 36px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 14px;
        }

        #info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        #info-header img {
            width: 28px; height: 28px;
            object-fit: contain;
            flex-shrink: 0;
        }

        #info-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            flex: 1;
        }

        #info-name.device { color: var(--device); }

        #info-close {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        #info-details {
            font-size: 0.78rem;
            border-top: 1px solid var(--border);
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label { color: var(--muted); }
        .detail-value { color: var(--text); font-weight: 700; }
        .detail-value.dist { color: var(--accent); font-size: 0.9rem; }

        /* Badges */
        #badges {
            position: absolute;
            top: 12px; right: 12px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .badge {
            background: var(--surface);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.74rem;
            color: var(--muted);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            white-space: nowrap;
        }

        .badge.active         { color: #22c55e; }
        .badge.compass.active { color: #f59e0b; }

        /* Bouton boussole */
        #compass-btn {
            position: absolute;
            top: 96px; left: 12px;
            z-index: 20;
            width: 36px; height: 36px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.15s;
        }

        #compass-btn.active { background: #fff8e7; border-color: #f59e0b; }

        /* Indicateur nord */
        #north-indicator {
            position: absolute;
            top: 96px; right: 12px;
            z-index: 20;
            width: 52px; height: 52px;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        #north-indicator.on { display: flex; }

        /* ContrÃ´les OL */
        .ol-zoom { top: 12px; left: 12px; right: auto; }
        .ol-zoom button {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 36px; height: 36px;
            font-size: 1.15rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .ol-attribution { display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="badges">
    <span class="badge" id="gps-badge">â³ GPSâ€¦</span>
    <span class="badge compass" id="compass-badge">ğŸ§­ inactif</span>
</div>

<button id="compass-btn" title="Orienter selon le nord">ğŸ§­</button>

<div id="north-indicator">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" width="52" height="52">
        <circle cx="26" cy="26" r="24" fill="white" stroke="#e2e6ee" stroke-width="1.5"/>
        <polygon points="26,3 31,26 26,21 21,26" fill="#e63946"/>
        <polygon points="26,49 21,26 26,31 31,26" fill="#c8cdd8"/>
        <text x="26" y="13" text-anchor="middle"
              font-family="sans-serif" font-size="8" font-weight="bold"
              fill="#e63946">N</text>
        <circle cx="26" cy="26" r="2.5" fill="#1a1d2e"/>
    </svg>
</div>

<!-- Fiche info au clic -->
<div id="info-panel">
    <div class="drag-handle"></div>
    <div id="info-header">
        <img id="info-img" src="marker.png" alt="">
        <span id="info-name">â€“</span>
        <button id="info-close">âœ•</button>
    </div>
    <div id="info-details">
        <div class="detail-row">
            <span class="detail-label">Latitude</span>
            <span class="detail-value" id="info-lat">â€“</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Longitude</span>
            <span class="detail-value" id="info-lon">â€“</span>
        </div>
        <div class="detail-row" id="info-dist-row" style="display:none;">
            <span class="detail-label">Distance</span>
            <span class="detail-value dist" id="info-dist">â€“</span>
        </div>
    </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DONNÃ‰ES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const somePlaces = [
    { name: "St Libert",  lonlat: [0.712889, 47.409500] },
    { name: "Monsoudun",  lonlat: [0.710978, 47.409539] },
    { name: "IUT",        lonlat: [0.703433, 47.408921] },
    { name: "CimetiÃ¨re",  lonlat: [0.698548, 47.406104] },
    { name: "Paul Bert",  lonlat: [0.694288, 47.402267] },
    { name: "Pont Nord",  lonlat: [0.693366, 47.402036] },
    { name: "Pont Loire", lonlat: [0.693073, 47.399575] },
    { name: "Pont Sud",   lonlat: [0.692840, 47.397504] },
    { name: "CathÃ©drale", lonlat: [0.693678, 47.395434] },
    { name: "MusÃ©e",      lonlat: [0.693962, 47.394764] },
    { name: "Bazoche",    lonlat: [0.696925, 47.395955] }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Haversine
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haversine(lat1, lon1, lat2, lon2) {
    const R  = 6371000;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a  = Math.sin(Î”Ï†/2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function formatDist(m) {
    return m < 1000 ? `${Math.round(m)} m` : `${(m / 1000).toFixed(2)} km`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Carte
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = new ol.Map({
    target: 'map',
    layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
    view: new ol.View({
        center: ol.proj.fromLonLat([0.700, 47.402]),
        zoom: 13
    }),
    controls: ol.control.defaults.defaults({ attribution: false })
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Marqueurs AR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const features = somePlaces.map((place, i) => {
    const f = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat(place.lonlat)),
        name: place.name || `Point ${i + 1}`,
        lonlat: place.lonlat,
        type: 'ar'
    });
    f.setStyle(new ol.style.Style({
        image: new ol.style.Icon({ src: 'marker.png', anchor: [0.5, 1], scale: 1.3 })
    }));
    return f;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Marqueur device
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const deviceFeature = new ol.Feature({ name: 'Ma position', type: 'device' });
deviceFeature.setStyle(new ol.style.Style({
    image: new ol.style.Icon({ src: 'device.png', anchor: [0.5, 0.5], scale: 1.2 })
}));

const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [...features, deviceFeature] })
});
map.addLayer(vectorLayer);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gpsBadge = document.getElementById('gps-badge');
let deviceLat = null, deviceLon = null;

if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
        (pos) => {
            deviceLon = pos.coords.longitude;
            deviceLat = pos.coords.latitude;
            deviceFeature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([deviceLon, deviceLat])));
            gpsBadge.textContent = 'â— GPS actif';
            gpsBadge.classList.add('active');
        },
        (err) => { gpsBadge.textContent = 'âœ— GPS'; console.error(err); },
        { enableHighAccuracy: true, maximumAge: 2000 }
    );
} else {
    gpsBadge.textContent = 'âœ— GPS';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Fiche info
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const infoPanel   = document.getElementById('info-panel');
const infoImg     = document.getElementById('info-img');
const infoName    = document.getElementById('info-name');
const infoLat     = document.getElementById('info-lat');
const infoLon     = document.getElementById('info-lon');
const infoDist    = document.getElementById('info-dist');
const infoDistRow = document.getElementById('info-dist-row');

function showInfo(feature) {
    const type = feature.get('type');
    const geom = feature.getGeometry();
    if (!geom) return;

    const ll = ol.proj.toLonLat(geom.getCoordinates());

    infoImg.src          = type === 'device' ? 'device.png' : 'marker.png';
    infoName.textContent = feature.get('name');
    infoName.className   = type === 'device' ? 'device' : '';
    infoLat.textContent  = ll[1].toFixed(6);
    infoLon.textContent  = ll[0].toFixed(6);

    if (type === 'ar' && deviceLat !== null) {
        const lonlat = feature.get('lonlat');
        infoDist.textContent      = formatDist(haversine(deviceLat, deviceLon, lonlat[1], lonlat[0]));
        infoDistRow.style.display = 'flex';
    } else {
        infoDistRow.style.display = 'none';
    }

    infoPanel.classList.add('visible');
}

document.getElementById('info-close').addEventListener('click', () => {
    infoPanel.classList.remove('visible');
});

// Clic carte : ouvre la fiche ou ferme si clic dans le vide
map.on('click', (e) => {
    const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
    if (feature && feature.getGeometry()) {
        map.getView().animate({ center: feature.getGeometry().getCoordinates(), duration: 350 });
        showInfo(feature);
    } else {
        infoPanel.classList.remove('visible');
    }
});

// Curseur pointer au survol d'un marker
map.on('pointermove', (e) => {
    const hit = map.forEachFeatureAtPixel(e.pixel, f => f);
    map.getViewport().style.cursor = (hit && hit.getGeometry()) ? 'pointer' : '';
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BOUSSOLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const compassBadge   = document.getElementById('compass-badge');
const compassBtn     = document.getElementById('compass-btn');
const northIndicator = document.getElementById('north-indicator');

let compassActive = false;
let headingBuffer = [];
const BUFFER_SIZE = 5;

function smoothHeading(val) {
    headingBuffer.push(val);
    if (headingBuffer.length > BUFFER_SIZE) headingBuffer.shift();
    let sinSum = 0, cosSum = 0;
    headingBuffer.forEach(h => {
        sinSum += Math.sin(h * Math.PI / 180);
        cosSum += Math.cos(h * Math.PI / 180);
    });
    return (Math.atan2(sinSum, cosSum) * 180 / Math.PI + 360) % 360;
}

function applyHeading(heading) {
    const smooth = smoothHeading(heading);
    map.getView().setRotation(smooth * Math.PI / 180);
    northIndicator.style.transform = `rotate(${-smooth}deg)`;
    compassBadge.textContent = `ğŸ§­ ${Math.round(smooth)}Â°`;
    compassBadge.classList.add('active');
}

function onOrientation(e) {
    if (!compassActive) return;
    let heading = null;
    if (e.webkitCompassHeading != null) heading = e.webkitCompassHeading;
    else if (e.alpha != null)           heading = (360 - e.alpha) % 360;
    if (heading !== null) applyHeading(heading);
}

function enableCompass() {
    compassActive = true;
    compassBtn.classList.add('active');
    northIndicator.classList.add('on');
    window.addEventListener('deviceorientationabsolute', onOrientation, true);
    window.addEventListener('deviceorientation',         onOrientation, true);
}

function disableCompass() {
    compassActive = false;
    compassBtn.classList.remove('active');
    northIndicator.classList.remove('on');
    headingBuffer = [];
    map.getView().setRotation(0);
    northIndicator.style.transform = 'rotate(0deg)';
    compassBadge.textContent = 'ğŸ§­ inactif';
    compassBadge.classList.remove('active');
    window.removeEventListener('deviceorientationabsolute', onOrientation, true);
    window.removeEventListener('deviceorientation',         onOrientation, true);
}

compassBtn.addEventListener('click', () => {
    if (compassActive) { disableCompass(); return; }
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(state => {
                if (state === 'granted') enableCompass();
                else compassBadge.textContent = 'ğŸ§­ refusÃ©e';
            }).catch(console.error);
    } else {
        enableCompass();
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Vue initiale
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
    if (features.length > 0) {
        const extent = vectorLayer.getSource().getExtent();
        map.getView().fit(extent, { padding: [40, 20, 40, 20], maxZoom: 16, duration: 800 });
    }
    map.updateSize();
});
</script>

</body>
</html>
