<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Carte AR</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --surface: #ffffff;
            --border: #e2e6ee;
            --accent: #e63946;
            --text: #1a1d2e;
            --muted: #8a929f;
            --device: #4285F4;
            --panel-h: 50px;
        }

        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            background: #e8edf2;
        }

        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        /* â”€â”€ Panneau bas â”€â”€ */
        #bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 10;
            background: var(--surface);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 12px rgba(0,0,0,0.10);
            border-radius: 14px 14px 0 0;
        }

        .drag-handle {
            width: 36px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 8px auto 4px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 18px;
            height: var(--panel-h);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s;
        }

        .row:last-child { border-bottom: none; }
        .row:active, .row.active { background: rgba(230,57,70,0.05); }

        .row img { width: 20px; height: 20px; object-fit: contain; flex-shrink: 0; }

        .row-name {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            flex: 1;
        }

        /* Bloc droite : distance + coords empilÃ©es */
        .row-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex-shrink: 0;
            gap: 1px;
        }

        .row-dist {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--accent);
            white-space: nowrap;
        }

        /* Distance inconnue (pas encore de GPS) */
        .row-dist.unknown { color: var(--muted); font-weight: 400; }

        .row-coords {
            font-size: 0.68rem;
            color: var(--muted);
            white-space: nowrap;
        }

        .row.device .row-name  { color: var(--device); }
        .row.device .row-dist  { color: var(--device); font-size: 0.74rem; font-weight: 400; }

        /* â”€â”€ Badges haut droite â”€â”€ */
        #badges {
            position: absolute;
            top: 12px; right: 12px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .badge {
            background: var(--surface);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.74rem;
            color: var(--muted);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            white-space: nowrap;
        }

        .badge.active         { color: #22c55e; }
        .badge.compass.active { color: #f59e0b; }

        /* â”€â”€ Bouton boussole â”€â”€ */
        #compass-btn {
            position: absolute;
            top: 96px; left: 12px;
            z-index: 20;
            width: 36px; height: 36px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.15s;
        }

        #compass-btn.active {
            background: #fff8e7;
            border-color: #f59e0b;
        }

        /* â”€â”€ Indicateur nord SVG â”€â”€ */
        #north-indicator {
            position: absolute;
            top: 96px; right: 12px;
            z-index: 20;
            width: 52px; height: 52px;
            display: none;
            align-items: center;
            justify-content: center;
            transform-origin: 50% 50%;
            pointer-events: none;
        }

        #north-indicator.on { display: flex; }

        /* â”€â”€ Popup â”€â”€ */
        .ol-popup {
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            border-radius: 6px;
            min-width: 160px;
            pointer-events: none;
            transform: translate(-50%, -115%);
            font-size: 0.82rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .ol-popup b    { display: block; margin-bottom: 4px; color: var(--accent); font-size: 0.86rem; }
        .ol-popup.device b { color: var(--device); }
        .ol-popup span { color: var(--muted); line-height: 1.7; font-size: 0.78rem; }

        /* â”€â”€ ContrÃ´les OL â”€â”€ */
        .ol-zoom { top: 12px; left: 12px; right: auto; }
        .ol-zoom button {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 36px; height: 36px;
            font-size: 1.15rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .ol-attribution { display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="badges">
    <span class="badge" id="gps-badge">â³ GPSâ€¦</span>
    <span class="badge compass" id="compass-badge">ğŸ§­ inactif</span>
</div>

<button id="compass-btn" title="Orienter selon le nord">ğŸ§­</button>

<div id="north-indicator">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" width="52" height="52">
        <circle cx="26" cy="26" r="24" fill="white" stroke="#e2e6ee" stroke-width="1.5"/>
        <polygon points="26,3 31,26 26,21 21,26" fill="#e63946"/>
        <polygon points="26,49 21,26 26,31 31,26" fill="#c8cdd8"/>
        <text x="26" y="13" text-anchor="middle"
              font-family="sans-serif" font-size="8" font-weight="bold"
              fill="#e63946">N</text>
        <circle cx="26" cy="26" r="2.5" fill="#1a1d2e"/>
    </svg>
</div>

<div id="popup" class="ol-popup" style="display:none;">
    <b id="popup-name"></b>
    <span id="popup-coords"></span>
</div>

<div id="bottom-panel">
    <div class="drag-handle"></div>
    <div class="row device" id="device-row">
        <img src="device.png" alt="device">
        <span class="row-name">Ma position</span>
        <div class="row-right">
            <span class="row-dist" id="device-coords">â€“</span>
        </div>
    </div>
    <div id="points-list"></div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DONNÃ‰ES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const somePlaces = [
    { name: "St Libert", lonlat: [0.712889, 47.409500] },
    { name: "Monsoudun", lonlat: [0.710978, 47.409539] },
    { name: "IUT", lonlat: [0.703433, 47.408921] },
    { name: "Point 4", lonlat: [0.694288, 47.402267] },
    { name: "Pont Nord", lonlat: [0.693366, 47.402036] },
    { name: "Pont Loire", lonlat: [0.693073, 47.399575] },
    { name: "Point 7", lonlat: [0.692966, 47.398520] },
    { name: "Pont Sud", lonlat: [0.692840, 47.397504] },
    { name: "CathÃ©drale", lonlat: [0.693678, 47.395434] },
    { name: "MusÃ©e", lonlat: [0.693962, 47.394764] },
    { name: "Bazoche", lonlat: [0.696925, 47.395955] }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Haversine â€” distance en mÃ¨tres entre deux points GPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haversine(lat1, lon1, lat2, lon2) {
    const R  = 6371000; // rayon Terre en mÃ¨tres
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a  = Math.sin(Î”Ï†/2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Formate la distance lisiblement
function formatDist(m) {
    if (m < 1000) return `${Math.round(m)} m`;
    return `${(m / 1000).toFixed(2)} km`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Carte
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = new ol.Map({
    target: 'map',
    layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
    view: new ol.View({
        center: ol.proj.fromLonLat([0.712, 47.36]),
        zoom: 12
    }),
    controls: ol.control.defaults.defaults({ attribution: false })
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Marqueurs AR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const features = somePlaces.map((place, i) => {
    const f = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat(place.lonlat)),
        name: place.name || `Point ${i + 1}`,
        lonlat: place.lonlat,
        type: 'ar'
    });
    f.setStyle(new ol.style.Style({
        image: new ol.style.Icon({ src: 'marker.png', anchor: [0.5, 1], scale: 1.3 })
    }));
    return f;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Marqueur device
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const deviceFeature = new ol.Feature({ name: 'Ma position', type: 'device' });
deviceFeature.setStyle(new ol.style.Style({
    image: new ol.style.Icon({ src: 'device.png', anchor: [0.5, 0.5], scale: 1.2 })
}));

const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({ features: [...features, deviceFeature] })
});
map.addLayer(vectorLayer);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GPS + mise Ã  jour distances
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gpsBadge     = document.getElementById('gps-badge');
const deviceCoords = document.getElementById('device-coords');
const deviceRow    = document.getElementById('device-row');

let deviceLat = null;
let deviceLon = null;

// RÃ©fÃ©rences aux spans de distance dans la liste (peuplÃ©es plus bas)
const distSpans = [];

function updateDistances() {
    if (deviceLat === null) return;
    somePlaces.forEach((place, i) => {
        const d = haversine(deviceLat, deviceLon, place.lonlat[1], place.lonlat[0]);
        if (distSpans[i]) {
            distSpans[i].textContent = formatDist(d);
            distSpans[i].classList.remove('unknown');
        }
    });
}

if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
        (pos) => {
            deviceLon = pos.coords.longitude;
            deviceLat = pos.coords.latitude;

            deviceFeature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([deviceLon, deviceLat])));
            deviceCoords.textContent = `${deviceLat.toFixed(5)}, ${deviceLon.toFixed(5)}`;
            gpsBadge.textContent = 'â— GPS actif';
            gpsBadge.classList.add('active');

            // Recalcul de toutes les distances
            updateDistances();
        },
        (err) => { gpsBadge.textContent = 'âœ— GPS'; console.error(err); },
        { enableHighAccuracy: true, maximumAge: 2000 }
    );
} else {
    gpsBadge.textContent = 'âœ— GPS';
}

deviceRow.addEventListener('click', () => {
    const geom = deviceFeature.getGeometry();
    if (geom) map.getView().animate({ center: geom.getCoordinates(), zoom: 17, duration: 500 });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BOUSSOLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const compassBadge   = document.getElementById('compass-badge');
const compassBtn     = document.getElementById('compass-btn');
const northIndicator = document.getElementById('north-indicator');

let compassActive = false;
let headingBuffer = [];
const BUFFER_SIZE = 5;

function smoothHeading(val) {
    headingBuffer.push(val);
    if (headingBuffer.length > BUFFER_SIZE) headingBuffer.shift();
    let sinSum = 0, cosSum = 0;
    headingBuffer.forEach(h => {
        sinSum += Math.sin(h * Math.PI / 180);
        cosSum += Math.cos(h * Math.PI / 180);
    });
    return (Math.atan2(sinSum, cosSum) * 180 / Math.PI + 360) % 360;
}

function applyHeading(heading) {
    const smooth = smoothHeading(heading);
    map.getView().setRotation(smooth * Math.PI / 180);
    northIndicator.style.transform = `rotate(${-smooth}deg)`;
    compassBadge.textContent = `ğŸ§­ ${Math.round(smooth)}Â°`;
    compassBadge.classList.add('active');
}

function onOrientation(e) {
    if (!compassActive) return;
    let heading = null;
    if (e.webkitCompassHeading != null) heading = e.webkitCompassHeading;
    else if (e.alpha != null)           heading = (360 - e.alpha) % 360;
    if (heading !== null) applyHeading(heading);
}

function enableCompass() {
    compassActive = true;
    compassBtn.classList.add('active');
    northIndicator.classList.add('on');
    window.addEventListener('deviceorientationabsolute', onOrientation, true);
    window.addEventListener('deviceorientation',         onOrientation, true);
}

function disableCompass() {
    compassActive = false;
    compassBtn.classList.remove('active');
    northIndicator.classList.remove('on');
    headingBuffer = [];
    map.getView().setRotation(0);
    northIndicator.style.transform = 'rotate(0deg)';
    compassBadge.textContent = 'ğŸ§­ inactif';
    compassBadge.classList.remove('active');
    window.removeEventListener('deviceorientationabsolute', onOrientation, true);
    window.removeEventListener('deviceorientation',         onOrientation, true);
}

compassBtn.addEventListener('click', () => {
    if (compassActive) { disableCompass(); return; }
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(state => {
                if (state === 'granted') enableCompass();
                else compassBadge.textContent = 'ğŸ§­ refusÃ©e';
            }).catch(console.error);
    } else {
        enableCompass();
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Liste points AR avec distance
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const list = document.getElementById('points-list');

somePlaces.forEach((place, i) => {
    const name = place.name || `Point ${i + 1}`;
    const row  = document.createElement('div');
    row.className    = 'row';
    row.dataset.name = name;
    row.innerHTML = `
        <img src="marker.png" alt="marker">
        <span class="row-name">${name}</span>
        <div class="row-right">
            <span class="row-dist unknown">â€“</span>
            <span class="row-coords">${place.lonlat[1].toFixed(5)}, ${place.lonlat[0].toFixed(5)}</span>
        </div>
    `;
    row.addEventListener('click', () => {
        map.getView().animate({ center: ol.proj.fromLonLat(place.lonlat), zoom: 17, duration: 500 });
        document.querySelectorAll('.row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
    });
    list.appendChild(row);

    // Garde une rÃ©fÃ©rence au span de distance pour mise Ã  jour en temps rÃ©el
    distSpans.push(row.querySelector('.row-dist'));
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Popup
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const popup       = document.getElementById('popup');
const popupName   = document.getElementById('popup-name');
const popupCoords = document.getElementById('popup-coords');

const overlayPopup = new ol.Overlay({
    element: popup, positioning: 'bottom-center', stopEvent: false
});
map.addOverlay(overlayPopup);

map.on('pointermove', (e) => {
    const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
    if (feature && feature.getGeometry()) {
        const geom = feature.getGeometry().getCoordinates();
        const ll   = ol.proj.toLonLat(geom);
        popupName.textContent = feature.get('name');

        // Ajoute la distance dans la popup si c'est un point AR
        let extra = '';
        if (feature.get('type') === 'ar' && deviceLat !== null) {
            const lonlat = feature.get('lonlat');
            const d = haversine(deviceLat, deviceLon, lonlat[1], lonlat[0]);
            extra = `<br>ğŸ“ ${formatDist(d)}`;
        }
        popupCoords.innerHTML = `${ll[1].toFixed(6)}<br>${ll[0].toFixed(6)}${extra}`;
        popup.className = 'ol-popup' + (feature.get('type') === 'device' ? ' device' : '');
        overlayPopup.setPosition(geom);
        popup.style.display = 'block';
        map.getViewport().style.cursor = 'pointer';
    } else {
        popup.style.display = 'none';
        map.getViewport().style.cursor = '';
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Vue initiale
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
    if (features.length > 1) {
        const ph = document.getElementById('bottom-panel').offsetHeight;
        const extent = vectorLayer.getSource().getExtent();
        map.getView().fit(extent, {
            padding: [40, 20, ph + 20, 20],
            maxZoom: 16, duration: 800
        });
    }
    map.updateSize();
});
</script>

</body>
</html>
