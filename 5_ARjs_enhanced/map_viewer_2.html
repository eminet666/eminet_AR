<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Points AR</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #f4f6f9;
            --surface: #ffffff;
            --border: #dde1ea;
            --accent: #e63946;
            --text: #1a1d2e;
            --muted: #6b7280;
        }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            z-index: 10;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        header h1 {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text);
        }

        header span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent);
            background: rgba(230,57,70,0.08);
            padding: 3px 10px;
            border-radius: 4px;
            border: 1px solid rgba(230,57,70,0.25);
        }

        /* Indicateur GPS dans le header */
        #gps-status {
            margin-left: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--muted);
        }

        #gps-status.active { color: #22c55e; }

        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-title {
            padding: 16px 20px 10px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        .points-list { overflow-y: auto; flex: 1; }

        .point-item {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .point-item:hover, .point-item.active {
            background: rgba(230,57,70,0.06);
        }

        .point-marker-icon { width: 18px; height: 22px; flex-shrink: 0; margin-top: 2px; }

        .point-info { flex: 1; }

        .point-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 4px; color: var(--text); }

        .point-coords {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            line-height: 1.6;
        }

        /* S√©parateur device dans la sidebar */
        .device-item {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: rgba(66,133,244,0.04);
        }

        .device-item .point-name { color: #4285F4; }

        #map { flex: 1; }

        .ol-popup {
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 12px 16px;
            border-radius: 6px;
            min-width: 180px;
            pointer-events: none;
            transform: translate(-50%, -110%);
            font-size: 0.82rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
        }

        .ol-popup-title { font-weight: 700; margin-bottom: 6px; color: var(--accent); }
        .ol-popup-title.device { color: #4285F4; }

        .ol-popup-coords {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--muted);
            line-height: 1.7;
        }

        .ol-zoom { top: 16px; right: 16px; left: auto; }
        .ol-zoom button {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1.1rem;
            width: 32px;
            height: 32px;
        }
        .ol-zoom button:hover { background: var(--bg); }
        .ol-attribution { display: none; }
    </style>
</head>
<body>

<header>
    <h1>üìç Carte AR</h1>
    <span id="point-count">0 points</span>
    <span id="gps-status">‚è≥ GPS en attente‚Ä¶</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="sidebar-title">Points de rep√®re</div>

        <!-- Position du device en haut de la sidebar -->
        <div class="device-item">
            <img class="point-marker-icon" src="device.png" alt="device">
            <div class="point-info">
                <div class="point-name">Ma position</div>
                <div class="point-coords" id="device-coords">‚Äì</div>
            </div>
        </div>

        <div class="points-list" id="points-list"></div>
    </aside>
    <div id="map"></div>
</div>

<div id="popup" class="ol-popup" style="display:none;">
    <div class="ol-popup-title" id="popup-title"></div>
    <div class="ol-popup-coords" id="popup-coords"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DONN√âES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let somePlaces = [
    { name: "Point 1", lonlat: [0.712889, 47.409500] },
    { name: "Point 2", lonlat: [0.710978, 47.409539] }
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Carte
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = new ol.Map({
    target: 'map',
    layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
    view: new ol.View({
        center: ol.proj.fromLonLat([0.712, 47.36]),
        zoom: 12
    }),
    controls: ol.control.defaults.defaults({ attribution: false })
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Marqueurs points AR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const markerStyle = new ol.style.Style({
    image: new ol.style.Icon({ src: 'marker.png', anchor: [0.5, 1], scale: 1.4 })
});

const features = somePlaces.map((place, i) => {
    const f = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat(place.lonlat)),
        name: place.name || `Point ${i + 1}`,
        lonlat: place.lonlat,
        type: 'ar'
    });
    f.setStyle(markerStyle);
    return f;
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Marqueur device (position GPS)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const deviceFeature = new ol.Feature({
    name: 'Ma position',
    type: 'device'
});
deviceFeature.setStyle(new ol.style.Style({
    image: new ol.style.Icon({
        src: 'device.png',
        anchor: [0.5, 0.5],  // centr√© sur le point GPS
        scale: 1.2
    })
}));
// Pas de g√©om√©trie initiale ‚Äî sera ajout√©e d√®s le premier fix GPS

const vectorSource = new ol.source.Vector({ features: [...features, deviceFeature] });
const vectorLayer  = new ol.layer.Vector({ source: vectorSource });
map.addLayer(vectorLayer);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GPS du device
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const gpsStatus   = document.getElementById('gps-status');
const deviceCoords = document.getElementById('device-coords');

if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
        (pos) => {
            const lon = pos.coords.longitude;
            const lat = pos.coords.latitude;

            // Mise √† jour du marqueur sur la carte
            deviceFeature.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([lon, lat])));

            // Mise √† jour sidebar
            deviceCoords.innerHTML = `lon : ${lon.toFixed(6)}<br>lat : ${lat.toFixed(6)}`;

            // Indicateur header
            gpsStatus.textContent = '‚óè GPS actif';
            gpsStatus.classList.add('active');
        },
        (err) => {
            gpsStatus.textContent = '‚úó GPS indisponible';
            console.error('GPS error:', err);
        },
        { enableHighAccuracy: true, maximumAge: 2000 }
    );
} else {
    gpsStatus.textContent = '‚úó GPS non support√©';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Popup au survol
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const popup      = document.getElementById('popup');
const popupTitle = document.getElementById('popup-title');
const popupCoords = document.getElementById('popup-coords');

const overlayPopup = new ol.Overlay({
    element: popup, positioning: 'bottom-center', stopEvent: false
});
map.addOverlay(overlayPopup);

map.on('pointermove', (e) => {
    const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
    if (feature && feature.getGeometry()) {
        const geom = feature.getGeometry().getCoordinates();
        const ll   = ol.proj.toLonLat(geom);
        popupTitle.textContent = feature.get('name');
        popupTitle.className   = 'ol-popup-title' + (feature.get('type') === 'device' ? ' device' : '');
        popupCoords.innerHTML  = `lon : ${ll[0].toFixed(6)}<br>lat : ${ll[1].toFixed(6)}`;
        overlayPopup.setPosition(geom);
        popup.style.display = 'block';
        map.getViewport().style.cursor = 'pointer';
    } else {
        popup.style.display = 'none';
        map.getViewport().style.cursor = '';
    }
});

// Clic ‚Üí zoom sur le point
map.on('click', (e) => {
    const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
    if (feature && feature.getGeometry()) {
        map.getView().animate({
            center: feature.getGeometry().getCoordinates(),
            zoom: 17, duration: 600
        });
        if (feature.get('type') === 'ar') highlightSidebarItem(feature.get('name'));
    }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Panneau lat√©ral ‚Äî points AR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const list = document.getElementById('points-list');
document.getElementById('point-count').textContent =
    `${somePlaces.length} point${somePlaces.length > 1 ? 's' : ''}`;

somePlaces.forEach((place, i) => {
    const name = place.name || `Point ${i + 1}`;
    const item = document.createElement('div');
    item.className = 'point-item';
    item.dataset.name = name;
    item.innerHTML = `
        <img class="point-marker-icon" src="marker.png" alt="marker">
        <div class="point-info">
            <div class="point-name">${name}</div>
            <div class="point-coords">lon : ${place.lonlat[0].toFixed(6)}<br>lat : ${place.lonlat[1].toFixed(6)}</div>
        </div>
    `;
    item.addEventListener('click', () => {
        map.getView().animate({ center: ol.proj.fromLonLat(place.lonlat), zoom: 17, duration: 600 });
        highlightSidebarItem(name);
    });
    list.appendChild(item);
});

function highlightSidebarItem(name) {
    document.querySelectorAll('.point-item').forEach(el => el.classList.remove('active'));
    const target = document.querySelector(`.point-item[data-name="${name}"]`);
    if (target) target.classList.add('active');
}

// Vue initiale englobant tous les points AR
if (features.length > 1) {
    const extent = vectorLayer.getSource().getExtent();
    map.getView().fit(extent, { padding: [60, 60, 60, 340], maxZoom: 16, duration: 800 });
}
</script>

</body>
</html>
